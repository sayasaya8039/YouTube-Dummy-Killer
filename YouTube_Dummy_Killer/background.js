(function(){"use strict";const k={enabled:!0,autoBlock:!1,showNotification:!0,minDateDifferenceHours:24};async function g(){const e=await chrome.storage.local.get(["blockedChannels","settings"]);return{blockedChannels:e.blockedChannels||[],settings:{...k,...e.settings}}}async function d(){const{blockedChannels:e}=await g();return e}async function T(e){const t=await d();t.some(s=>s.channelId===e.channelId)||(t.push(e),await chrome.storage.local.set({blockedChannels:t}))}async function y(e){const s=(await d()).filter(n=>n.channelId!==e);await chrome.storage.local.set({blockedChannels:s})}async function w(){const{settings:e}=await g();return e}async function D(e){const s={...await w(),...e};await chrome.storage.local.set({settings:s})}function S(e){const t="var ytInitialData = ",s=e.indexOf(t);if(s===-1)return null;const n=s+t.length;let r=0,o=!1,i=!1;for(let a=n;a<e.length;a++){const c=e[a];if(i){i=!1;continue}if(c==="\\"&&o){i=!0;continue}if(c==='"'&&!i){o=!o;continue}if(!o){if(c==="{")r++;else if(c==="}"&&(r--,r===0)){const u=e.slice(n,a+1);try{return JSON.parse(u)}catch{return null}}}}return null}async function b(e){const t=`https://www.youtube.com/results?search_query=${encodeURIComponent(e)}&sp=CAI%253D`;try{const n=await(await fetch(t,{headers:{"Accept-Language":"ja-JP,ja;q=0.9","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"}})).text(),r=S(n);return r?A(r):[]}catch{return[]}}function A(e){var s,n,r,o,i;const t=[];try{const a=(o=(r=(n=(s=e==null?void 0:e.contents)==null?void 0:s.twoColumnSearchResultsRenderer)==null?void 0:n.primaryContents)==null?void 0:r.sectionListRenderer)==null?void 0:o.contents;if(!a)return t;for(const c of a){const u=(i=c==null?void 0:c.itemSectionRenderer)==null?void 0:i.contents;if(u)for(const l of u){const h=l==null?void 0:l.videoRenderer;if(!h)continue;const f=C(h);f&&t.push(f)}}}catch{}return t}function C(e){var t,s,n,r,o,i,a,c,u,l,h,f,p,m,I;try{const L=e.videoId,U=((n=(s=(t=e.title)==null?void 0:t.runs)==null?void 0:s[0])==null?void 0:n.text)||"",_=((c=(a=(i=(o=(r=e.ownerText)==null?void 0:r.runs)==null?void 0:o[0])==null?void 0:i.navigationEndpoint)==null?void 0:a.browseEndpoint)==null?void 0:c.browseId)||"",M=((h=(l=(u=e.ownerText)==null?void 0:u.runs)==null?void 0:l[0])==null?void 0:h.text)||"",O=((f=e.publishedTimeText)==null?void 0:f.simpleText)||"",R=((I=(m=(p=e.thumbnail)==null?void 0:p.thumbnails)==null?void 0:m[0])==null?void 0:I.url)||"",B=E(O);return{videoId:L,title:U,channelId:_,channelName:M,publishedAt:B,thumbnailUrl:R}}catch{return null}}function E(e){const t=new Date;if(!e)return t;const s=e.match(/(\d+)\s*(秒|分|時間|日|週間|か月|年)前/);if(!s)return t;const n=parseInt(s[1],10);switch(s[2]){case"秒":t.setSeconds(t.getSeconds()-n);break;case"分":t.setMinutes(t.getMinutes()-n);break;case"時間":t.setHours(t.getHours()-n);break;case"日":t.setDate(t.getDate()-n);break;case"週間":t.setDate(t.getDate()-n*7);break;case"か月":t.setMonth(t.getMonth()-n);break;case"年":t.setFullYear(t.getFullYear()-n);break}return t}async function N(e){const t={...e,publishedAt:typeof e.publishedAt=="string"?new Date(e.publishedAt):e.publishedAt},s=await b(t.title);if(s.length===0)return null;const n=s.filter(a=>a.videoId!==t.videoId);if(n.length===0)return null;const r=n.reduce((a,c)=>a.publishedAt.getTime()<c.publishedAt.getTime()?a:c);return(t.publishedAt.getTime()-r.publishedAt.getTime())/(1e3*60*60)>24?r:null}chrome.runtime.onMessage.addListener((e,t,s)=>t.id!==chrome.runtime.id?(s({success:!1,error:"Unauthorized sender"}),!0):(x(e).then(n=>s({success:!0,data:n})).catch(n=>s({success:!1,error:n instanceof Error?n.message:"Unknown error"})),!0));async function x(e){switch(e.type){case"BLOCK_CHANNEL":return await T(e.channel),null;case"UNBLOCK_CHANNEL":return await y(e.channelId),null;case"GET_BLOCKED_CHANNELS":return await d();case"GET_SETTINGS":return await w();case"UPDATE_SETTINGS":return await D(e.settings),null;case"SEARCH_VIDEOS":return await b(e.query);case"FIND_ORIGINAL":return await N(e.currentVideo);default:throw new Error("Unknown message type")}}chrome.runtime.onInstalled.addListener(()=>{})})();
