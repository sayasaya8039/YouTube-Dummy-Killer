(function(){"use strict";const y={enabled:!0,autoBlock:!1,showNotification:!0,minDateDifferenceHours:24};async function g(){const e=await chrome.storage.local.get(["blockedChannels","settings"]);return{blockedChannels:e.blockedChannels||[],settings:{...y,...e.settings}}}async function f(){const{blockedChannels:e}=await g();return e}async function D(e){const t=await f();t.some(n=>n.channelId===e.channelId)||(t.push(e),await chrome.storage.local.set({blockedChannels:t}))}async function T(e){const n=(await f()).filter(s=>s.channelId!==e);await chrome.storage.local.set({blockedChannels:n})}async function w(){const{settings:e}=await g();return e}async function S(e){const n={...await w(),...e};await chrome.storage.local.set({settings:n})}function k(e){const t="var ytInitialData = ",n=e.indexOf(t);if(n===-1)return null;const s=n+t.length;let a=0,c=!1,i=!1;for(let r=s;r<e.length;r++){const o=e[r];if(i){i=!1;continue}if(o==="\\"&&c){i=!0;continue}if(o==='"'&&!i){c=!c;continue}if(!c){if(o==="{")a++;else if(o==="}"&&(a--,a===0)){const l=e.slice(s,r+1);try{return JSON.parse(l)}catch{return console.error("Failed to parse ytInitialData"),null}}}}return null}async function b(e){const t=`https://www.youtube.com/results?search_query=${encodeURIComponent(e)}&sp=CAI%253D`;try{const s=await(await fetch(t,{headers:{"Accept-Language":"ja-JP,ja;q=0.9","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"}})).text(),a=k(s);return a?A(a):(console.error("ytInitialData not found"),[])}catch(n){return console.error("Search failed:",n),[]}}function A(e){var n,s,a,c,i;const t=[];try{const r=(c=(a=(s=(n=e==null?void 0:e.contents)==null?void 0:n.twoColumnSearchResultsRenderer)==null?void 0:s.primaryContents)==null?void 0:a.sectionListRenderer)==null?void 0:c.contents;if(!r)return t;for(const o of r){const l=(i=o==null?void 0:o.itemSectionRenderer)==null?void 0:i.contents;if(l)for(const u of l){const h=u==null?void 0:u.videoRenderer;if(!h)continue;const d=C(h);d&&t.push(d)}}}catch(r){console.error("Parse error:",r)}return t}function C(e){var t,n,s,a,c,i,r,o,l,u,h,d,p,m,I;try{const L=e.videoId,_=((s=(n=(t=e.title)==null?void 0:t.runs)==null?void 0:n[0])==null?void 0:s.text)||"",R=((o=(r=(i=(c=(a=e.ownerText)==null?void 0:a.runs)==null?void 0:c[0])==null?void 0:i.navigationEndpoint)==null?void 0:r.browseEndpoint)==null?void 0:o.browseId)||"",M=((h=(u=(l=e.ownerText)==null?void 0:l.runs)==null?void 0:u[0])==null?void 0:h.text)||"",O=((d=e.publishedTimeText)==null?void 0:d.simpleText)||"",U=((I=(m=(p=e.thumbnail)==null?void 0:p.thumbnails)==null?void 0:m[0])==null?void 0:I.url)||"",B=E(O);return{videoId:L,title:_,channelId:R,channelName:M,publishedAt:B,thumbnailUrl:U}}catch{return null}}function E(e){const t=new Date;if(!e)return t;const n=e.match(/(\d+)\s*(秒|分|時間|日|週間|か月|年)前/);if(!n)return t;const s=parseInt(n[1],10);switch(n[2]){case"秒":t.setSeconds(t.getSeconds()-s);break;case"分":t.setMinutes(t.getMinutes()-s);break;case"時間":t.setHours(t.getHours()-s);break;case"日":t.setDate(t.getDate()-s);break;case"週間":t.setDate(t.getDate()-s*7);break;case"か月":t.setMonth(t.getMonth()-s);break;case"年":t.setFullYear(t.getFullYear()-s);break}return t}async function N(e){const t={...e,publishedAt:typeof e.publishedAt=="string"?new Date(e.publishedAt):e.publishedAt},n=await b(t.title);if(n.length===0)return null;const s=n.filter(r=>r.videoId!==t.videoId);if(s.length===0)return null;const a=s.reduce((r,o)=>r.publishedAt.getTime()<o.publishedAt.getTime()?r:o);return(t.publishedAt.getTime()-a.publishedAt.getTime())/(1e3*60*60)>24?a:null}chrome.runtime.onMessage.addListener((e,t,n)=>(x(e).then(s=>n({success:!0,data:s})).catch(s=>n({success:!1,error:s.message})),!0));async function x(e){switch(e.type){case"BLOCK_CHANNEL":return await D(e.channel),null;case"UNBLOCK_CHANNEL":return await T(e.channelId),null;case"GET_BLOCKED_CHANNELS":return await f();case"GET_SETTINGS":return await w();case"UPDATE_SETTINGS":return await S(e.settings),null;case"SEARCH_VIDEOS":return await b(e.query);case"FIND_ORIGINAL":return await N(e.currentVideo);default:throw new Error("Unknown message type")}}chrome.runtime.onInstalled.addListener(()=>{console.log("YouTube Dummy Killer installed")})})();
